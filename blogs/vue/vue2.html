<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue 2.x 响应式原理深度剖析 | FXburning</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="FXburning's blogs">
    
    <link rel="preload" href="/fxburning/assets/css/0.styles.2ca31dc4.css" as="style"><link rel="preload" href="/fxburning/assets/js/app.9058f1ce.js" as="script"><link rel="preload" href="/fxburning/assets/js/2.ee1c7fd8.js" as="script"><link rel="preload" href="/fxburning/assets/js/12.e04f6e73.js" as="script"><link rel="prefetch" href="/fxburning/assets/js/10.d2ba6420.js"><link rel="prefetch" href="/fxburning/assets/js/11.6abb7d57.js"><link rel="prefetch" href="/fxburning/assets/js/13.121651d0.js"><link rel="prefetch" href="/fxburning/assets/js/14.34a6478e.js"><link rel="prefetch" href="/fxburning/assets/js/3.7e6d5160.js"><link rel="prefetch" href="/fxburning/assets/js/4.24ff827e.js"><link rel="prefetch" href="/fxburning/assets/js/5.4a646df1.js"><link rel="prefetch" href="/fxburning/assets/js/6.7a0f80e6.js"><link rel="prefetch" href="/fxburning/assets/js/7.77050805.js"><link rel="prefetch" href="/fxburning/assets/js/8.0a84bc37.js"><link rel="prefetch" href="/fxburning/assets/js/9.87b890b6.js">
    <link rel="stylesheet" href="/fxburning/assets/css/0.styles.2ca31dc4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/fxburning/" class="home-link router-link-active"><!----> <span class="site-name">FXburning</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/fxburning/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/fxburning/blogs/" class="nav-link router-link-active">
  Blogs
</a></div><div class="nav-item"><a href="/fxburning/other/" class="nav-link">
  Others
</a></div><div class="nav-item"><a href="/fxburning/FXburning/" class="nav-link">
  About
</a></div><div class="nav-item"><a href="https://github.com/FXburning" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/fxburning/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/fxburning/blogs/" class="nav-link router-link-active">
  Blogs
</a></div><div class="nav-item"><a href="/fxburning/other/" class="nav-link">
  Others
</a></div><div class="nav-item"><a href="/fxburning/FXburning/" class="nav-link">
  About
</a></div><div class="nav-item"><a href="https://github.com/FXburning" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vue-2-x-响应式原理深度剖析"><a href="#vue-2-x-响应式原理深度剖析" class="header-anchor">#</a> Vue 2.x 响应式原理深度剖析</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>前端技术层出不穷，<code>Vue3.0</code> 出来都已经几个月了，在面对这些层出不穷的库或者框架时，我们在熟练掌握其使用后也要对其原理层面的知识有一定深度的了解。这不仅对我们在面试求职时锦上添花，还会让我们对框架本身的使用和其拥有的<strong>独特的思想</strong>有更深层次的认识。</p> <p>本文会先从 <code>Vue</code> 独特的思想到 <code>2.x</code> 中的响应式原理的基本实现以及它的优缺点来彻底搞清 <code>Vue</code> 中的响应式原理。</p> <blockquote><p>之后也会更新出剖析 <code>Vue3.x</code> 中的响应式原理和 <code>2.x</code> 与 <code>3.x</code> 对比的文章，可以关注查看后续的更新。</p></blockquote> <h2 id="响应式思想"><a href="#响应式思想" class="header-anchor">#</a> 响应式思想</h2> <p>使用过 <code>Vue</code> 的同学肯定知道它是使用了 <code>MVVM</code> 的模式，主要是分离<strong>视图</strong>和<strong>模型</strong>，本质上是 <code>MVC</code> 的改进版。
<img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/849fda0fc0724ab3847a07f138b19531~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>可以看到上图中，视图层与数据层分离，中间通过框架来进行通讯完成响应式。</p> <ul><li>当视图更改时框架内部监测到后影响到数据的更改。</li> <li>相应的当数据发生变化时，视图也会响应式的自动更改。</li></ul> <blockquote><p>如果你了解 <code>React</code>，那么你可以将 <code>MVC</code> 与 <code>MVVM</code> 做出一个对比，就可以对双向绑定有更深层次的认识。</p></blockquote> <p>了解了简单的 <code>MVVM</code> 模式后，我们就来探究一下在 <code>Vue</code> 中是如何实现中间的通讯层的。</p> <h2 id="vue-2-x"><a href="#vue-2-x" class="header-anchor">#</a> Vue 2.x</h2> <p>先来看一张在 <code>Vue2.x</code> 中的基础架构图：</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f73eaf8d024149d885254ca98c9f8481~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p> <p>其实在这张图中，很多的名词我们都耳熟能详，或者肯定会有一定的了解，我先来简单的解释一下，后面会对图中所有的模块逐一分析实现。</p> <ul><li><strong>Observer</strong>：观察者，通过对 <code>MVVM</code> 模式的了解，我们知道要对视图或者数据进行观察监测，监听它们的变化之后做出一系列操作。</li> <li><strong>Dep</strong>：依赖收集器，收集模板中所有对数据有依赖的地方，当视图或者数据变化时，就去通知依赖收集器中的依赖做出相应的更新。</li> <li><strong>Watcher</strong>：监听器，在依赖收集器中包含着一个个的监听器，监听器会在模板编译的过程中<strong>自动</strong>将自己添加到依赖收集器中。</li> <li><strong>Compile</strong>：编译，编译指令 <code>v-xxx</code> 以及模板语法 <code></code>。</li></ul> <p>在对图中的名词做出解释后，我们会进入每一个模块来深度的剖析它们的实现原理。</p> <h3 id="new-vue"><a href="#new-vue" class="header-anchor">#</a> <code>new Vue()</code></h3> <p>我们新建一个 <code>Vue.js</code> 文件并在自己的 <code>index.html</code> 文件中引入，我们采用模块化的开发：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> index<span class="token punctuation">.</span>html <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;app&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;module&quot;</span><span class="token operator">&gt;</span>
   <span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'./Vue.js'</span>
   <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      el<span class="token operator">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
      data<span class="token operator">:</span> <span class="token punctuation">{</span>
         name<span class="token operator">:</span> <span class="token string">'seven'</span><span class="token punctuation">,</span>
         info<span class="token operator">:</span> <span class="token punctuation">{</span>
            age<span class="token operator">:</span> <span class="token number">20</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 这里是为了在浏览器控制台中使用 vm 变量来调试 <span class="token operator">--</span><span class="token operator">&gt;</span>
   window<span class="token punctuation">.</span>vm <span class="token operator">=</span> vm
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
</code></pre></div><p>这是一段简单的 <code>demo</code>，我们在 <code>Vue.js</code> 中新建 <code>Vue</code> 类：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Vue.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Vue</span> <span class="token punctuation">{</span>
   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>$options <span class="token operator">=</span> options
      <span class="token keyword">this</span><span class="token punctuation">.</span>$el <span class="token operator">=</span> <span class="token keyword">typeof</span> options<span class="token punctuation">.</span>el <span class="token operator">===</span> <span class="token string">'string'</span>
         <span class="token operator">?</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
         <span class="token operator">:</span> options<span class="token punctuation">.</span>el
      <span class="token keyword">this</span><span class="token punctuation">.</span>$data <span class="token operator">=</span> <span class="token keyword">typeof</span> options<span class="token punctuation">.</span>data <span class="token operator">===</span> <span class="token string">'function'</span>
         <span class="token operator">?</span> options<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token operator">:</span> options<span class="token punctuation">.</span>data
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到上面的代码只是简单的给实例对象 <code>vm</code> 上挂载了 <code>$options</code>、<code>$el</code>、<code>$data</code> 属性，分别拿到 <code>new</code> 时的参数和 <code>DOM</code> 元素，以及数据。
打印一下 <code>vm</code>：</p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/97782358d22f4cf5a7ce84dc628685da~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <blockquote><p>当然这里初始化 <code>Vue</code> 类的时候的判断并不严谨，你可以加一些 <code>warning</code> 或者 <code>error</code> 信息避免别人使用的时候传参错误。</p></blockquote> <h3 id="数据代理"><a href="#数据代理" class="header-anchor">#</a> 数据代理</h3> <p>我们在实现响应式之前先来实现 <code>Vue</code> 中的数据代理，我们在使用 <code>Vue</code> 的时候，或者 <code>data</code> 中的数据直接是 <code>this.name</code> 或者 <code>this.info</code>，并不会使用 <code>this.$data.name</code> 尽管这样是可行的，但是会让我们的每次取值都变得很麻烦。所以在 <code>Vue</code> 中为我们实现了数据的代理。我们来看一下内部的实现：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Vue.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Vue</span> <span class="token punctuation">{</span>
   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>$options <span class="token operator">=</span> options
      <span class="token keyword">this</span><span class="token punctuation">.</span>$el <span class="token operator">=</span> <span class="token keyword">typeof</span> options<span class="token punctuation">.</span>el <span class="token operator">===</span> <span class="token string">'string'</span>
         <span class="token operator">?</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
         <span class="token operator">:</span> options<span class="token punctuation">.</span>el
      <span class="token keyword">this</span><span class="token punctuation">.</span>$data <span class="token operator">=</span> <span class="token keyword">typeof</span> options<span class="token punctuation">.</span>data <span class="token operator">===</span> <span class="token string">'function'</span>
         <span class="token operator">?</span> options<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token operator">:</span> options<span class="token punctuation">.</span>data

      <span class="token comment">// 数据代理</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">proxyData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

   <span class="token function">proxyData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   	  <span class="token comment">// 循环遍历 this.$data 上的属性</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// 使用 Object.defineProperty Api 给 this 上扩展这些属性</span>
         Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            configurable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token comment">// 取值时取 this.$data 中对应的值</span>
            <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$data<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token comment">// 设置值时直接设置 this.$data 中的值</span>
            <span class="token function">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$data<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">this</span><span class="token punctuation">.</span>$data<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> newValue
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此时我们在浏览器中测试一下：</p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1376a9aff1a9429897d1462546418b0e~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>这样我们就已经实现了数据代理，<code>this.$data</code> 中的数据可以直接使用 <code>this</code> 来获取和修改。</p> <h3 id="observer-数据观测"><a href="#observer-数据观测" class="header-anchor">#</a> Observer 数据观测</h3> <p>我们先来实现一个观察者，该类用来将数据变成响应式的，在 <code>Vue</code> 的构造函数中我们 <code>new Observer</code> ，这其实是一个 <strong>建造者模式</strong> 的体现。</p> <blockquote><p>关于建造者模式，更多详情你可以翻阅其他资料进行了解，简单来说建造者模式就是为了创建一个复杂的对象时使用的设计模式。</p></blockquote> <p>在 <code>Vue.js</code> 中我们引入外部的 <code>Observer.js</code> 文件，并且在构造函数中实例化它：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Vue.js</span>
<span class="token keyword">import</span> Observer <span class="token keyword">from</span> <span class="token string">'./Observer.js'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Vue</span> <span class="token punctuation">{</span>
   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
      <span class="token comment">// 数据代理</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">proxyData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// 数据观测</span>
      <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$data<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接着我们就可以创建 <code>Observer.js</code> 文件：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Observer.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>
   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 将数据变成响应式的</span>
   <span class="token function">observe</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 <code>Observer</code> 类中我们要对 <code>data</code> 数据进行观测，也就是将它简称响应式的数据，逻辑封装在 <code>observe</code> 函数中。</p> <p>我们知道 <code>Vue2.x</code> 的响应式实现时依赖了 <code>Object.defineProperty</code> 这一 <code>API</code>，接下来就让我们具体来看一下是怎么实现的吧：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Observer.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>
   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

   <span class="token function">observe</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 循环遍历数据</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">const</span> value <span class="token operator">=</span> data<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
         <span class="token function">defineReactive</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 深度检测，如果该属性值还是一个对象，也要将其变成响应式的</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 将数据的每一个属性都变成 getter 和 setter 的形式，实现侦测</span>
   Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      configurable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> value
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">!==</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            value <span class="token operator">=</span> newValue
            <span class="token comment">// 该属性被赋予的新值也要对其进行变化侦测</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面的代码就是一个 <code>Observer</code> 类的基本实现，目的就是为了将 <code>data</code> 中的所有的属性都变成 <code>getter</code> 和 <code>setter</code> 的形式从而讲其变成响应式的。目前为止，我们的工作还差很多，需要实现了后面的操作后才能看到效果。</p> <p>到这里，我们可以先来暂停一下来分析一下 <code>Observer</code> 类中的核心代码。根据分析，在我们 <code>new Vue()</code> 传入 <code>data</code> 数据的时候，会默认自动的进行 <code>new Observer</code> 操作，此时会直接对 <code>data</code> 数据进行深层次的响应式转化，会很浪费性能。</p> <p>意思也就是说，当我们的初始化 <code>data</code> 数据是一个嵌套层次很深的对象类型的数据时，默认一上来就会进行递归操作讲所有的 <code>key</code> 都变成 <code>getter</code> 和 <code>setter</code> 形式，这会造成性能的浪费。但是这是不可避免的。但是在 <code>Vue3.0</code> 中由于没有使用 <code>Object.defineProperty</code> 这一特性，所以初始化数据的时候没有进行递归操作，性能得到了大幅度提升。后续我们会讲到。</p> <p>除了对初始化数据时的性能不好的分析外，我们还应该分析到对于对象类型的数据来说，<strong>新增和删除属性</strong>时，是不能被侦测到的。知道了原理后，这也很好解释，因为 <code>for ... in ...</code> 循环遍历不到新添加的属性，<code>Object.defineProperty</code> 也不能监测到删除的操作。所以对于对象类型的数据来说，新增和删除属性是不能被监测到的。</p> <blockquote><p>虽然因为 <code>Object.defineProperty</code> 这一 <code>API</code> 的缺点我们无法侦测对象数据的新增属性和删除属性的操作，但是 <code>Vue2.x</code> 中为我们实现好了 <code>$set</code> 方法来弥补这一缺失。有关 <code>$set</code> 特性的实现这里不再讲解。</p></blockquote> <div class="language-! extra-class"><pre class="language-text"><code>特别提醒
知道了这些原理后，我们在以后的开发中遇到为对象新增删除属性的操作时就要使用 `$set` 来实现。
</code></pre></div><p>对于数组的变化侦测，我打算放到最后讲解，我们先就对象来走完所有的响应式流程。</p> <h3 id="dep-依赖收集"><a href="#dep-依赖收集" class="header-anchor">#</a> Dep 依赖收集</h3> <p>上面我们已经将数据变成了 <code>getter</code> 和 <code>setter</code> 的形式，我们需要知道：</p> <ul><li>在访问对象的属性时会调用 <code>getter</code> 方法，例如：访问 <code>vm.name</code></li> <li>在设置对象的属性时会调用 <code>setter</code> 方法，例如：设置 <code>vm.name = 'juejin'</code></li></ul> <p>我们将数据变成这种形式的目的就是为了<strong>获取使用了数据的地方</strong>以及<strong>拦截修改数据的操作</strong>。
我们称前者获取使用了数据的地方为<strong>依赖收集</strong>，后者拦截修改数据的操作为<strong>数据劫持</strong>。</p> <p><strong>那么依赖收集的目的是什么呢？</strong></p> <p>我们将页面中使用了数据的地方进行收集，等待拦截到数据修改的操作后我们通知这些使用了数据的地方更新数据，这就是响应式原理的核心。</p> <p>所以接下来我们来实现一下依赖收集这一模块，同样我们需要写一个类，在需要收集依赖的地方实例化这个类，新建一个 <code>Dep.js</code> 文件，到这里我们可以再来看一看之前的那张图：</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f73eaf8d024149d885254ca98c9f8481~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p> <p>可以看到 <code>Dep</code> 应该具有<strong>添加依赖</strong>和<strong>通知所有依赖</strong>的方法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Dep.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>
   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 使用数据储存所有的依赖</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
   <span class="token punctuation">}</span>
   
   <span class="token comment">// 向数组中添加依赖的方法</span>
   <span class="token function">addDep</span><span class="token punctuation">(</span><span class="token parameter">dep</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   
   <span class="token comment">// 通知所有依赖，让依赖触发它们的更新方法</span>
   <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">w</span> <span class="token operator">=&gt;</span> w<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>到这里，我们的 <code>Dep</code> 类就写好了，只是还没有使用它，使用它之前我们要弄明白 <code>deps</code> 中储存的依赖项究竟是什么？其实就是一个 <code>watcher</code>。</p> <h3 id="watcher-监听器"><a href="#watcher-监听器" class="header-anchor">#</a> Watcher 监听器</h3> <p>我们先来介绍一下一个 <code>watcher</code> 的基本使用：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">oldValue<span class="token punctuation">,</span> newValue</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>你可能已经发现了这个跟我们平时在 <code>Vue</code> 中使用的 <code>watch</code> 特别的相似。其实，<code>watch</code> 就是它的封装。</p> <p>接下来就让我们来实现一下 <code>Watcher</code> 类，这里先注意之前提到过的一点：<strong>watcher 会自动将自己添加到依赖收集器中</strong>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Watcher.js</span>
<span class="token comment">// 导入 Dep ，为了往 Dep 类上挂载静态属性</span>
<span class="token keyword">import</span> Dep <span class="token keyword">from</span> <span class="token string">&quot;./Dep.js&quot;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>
   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> expr<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> vm
      <span class="token keyword">this</span><span class="token punctuation">.</span>expr <span class="token operator">=</span> expr
      <span class="token keyword">this</span><span class="token punctuation">.</span>callback <span class="token operator">=</span> callback
      <span class="token comment">// 获取老值</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>oldValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

   <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 获取老值前给 Dep 类上添加静态属性 target 指向自身实例对象</span>
      Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">this</span>
      <span class="token keyword">const</span> oldValue <span class="token operator">=</span> <span class="token function">getVal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>expr<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">)</span>
      <span class="token comment">// 取值完后删除静态属性</span>
      Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token keyword">return</span> oldValue
   <span class="token punctuation">}</span>

   <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 更新时获取新值并触发回调函数</span>
      <span class="token keyword">const</span> newValue <span class="token operator">=</span> <span class="token function">getVal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>expr<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">,</span> newValue<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>oldValue<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 取值的辅助函数，由于 expr 可能会传值 info.age 等，此时需要解析</span>
<span class="token keyword">function</span> <span class="token function">getVal</span><span class="token punctuation">(</span><span class="token parameter">expr<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> expr<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> currentVal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> data<span class="token punctuation">[</span>currentVal<span class="token punctuation">]</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span> vm<span class="token punctuation">.</span>$data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到 <code>Watcher</code> 类中有一个惊人的操作，就是在 <code>getValue</code> 方法中。每当我们 <code>new Watcher</code> 的时候，会自动调用这个方法，并且给 <code>Dep</code> 添加静态属性 <code>target</code> 指向实例对象本身，获取之后将其移除。</p> <p>可能你看到这里后觉得这并没有什么稀奇的，还会觉得多此一举。如果是这样，我来提醒你一点，你忽略了中间的取值操作：<code>this.vm[key]</code>。</p> <p>这是在取值，取值不就会触发 <code>getter</code> 方法吗，那在取值的这一步操作中就刚好可以获取到 <code>Dep.target</code> 的值了，并且取值后它就不存在了，这是为了防止同一依赖被收集多次，造成重复的更新。</p> <p>顺着这个思路我们就应该回到 <code>Observer</code> 类中来使用依赖收集器来添加依赖了。我们需要在 <code>getter</code> 中收集依赖，在 <code>setter</code> 中通知依赖更新。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Observer.js</span>
<span class="token keyword">import</span> Dep <span class="token keyword">from</span> <span class="token string">&quot;./Dep.js&quot;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>
   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

   <span class="token function">observe</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">const</span> value <span class="token operator">=</span> data<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
         <span class="token function">defineReactive</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 创建依赖收集器</span>
   <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      configurable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// 收集依赖</span>
         Dep<span class="token punctuation">.</span>target <span class="token operator">&amp;&amp;</span> dep<span class="token punctuation">.</span><span class="token function">addDep</span><span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span>
         <span class="token keyword">return</span> value
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">!==</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            value <span class="token operator">=</span> newValue
            <span class="token comment">// 通知依赖</span>
            dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>目前为止，对于对象类型的数据来说，图中的上半部分就已经完成了，也就是完成了响应式的核心代码。但是此时我们并不能看到任何的结果，甚至我们还没有使用 <code>Watcher</code> 类，那么现在就让我们完成 <code>Compile</code> 编译模块的书写，以便检验我们响应式系统的实现。</p> <h3 id="compile"><a href="#compile" class="header-anchor">#</a> Compile</h3> <p>分析 <code>Compile</code> 模块，我们需要在数据劫持后进行模块的编译，否则编译之后的视图不再依赖数据，所以 <code>new Compile</code> 的操作需要放到 <code>new Observer</code> 之后。</p> <p>在进行编译的时候我们有两个大的方向：</p> <ul><li>需要对指令 <code>v-xxx</code> 进行编译</li> <li>需要对模板语法 <code></code> 进行编译
对于这两步我们都需要获取到 <code>vm.$el</code> 从根元素开始遍历所有的节点，获取每一个节点中的属性和文本内容，如果需要解析则进行解析。</li></ul> <p>知道这个主导方向之后，我们先来实现 <code>Compile</code> 的基本骨架，在这以前我们需要模拟一些指令和模板语法在页面中以及在 <code>Vue.js</code> 中使用 <code>Compile</code>：</p> <div class="language-html extra-class"><pre class="language-html"><code>// index.html
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>{{ name }} -- {{ info.age }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token attr-name">v-text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">v-html</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>htmlText<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">v-bind:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>link<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>百度<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name"><span class="token namespace">v-on:</span>click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>clickHandler<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>按钮<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
   <span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'./Vue.js'</span>
   <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      el<span class="token operator">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
      data<span class="token operator">:</span> <span class="token punctuation">{</span>
         name<span class="token operator">:</span> <span class="token string">'seven'</span><span class="token punctuation">,</span>
         info<span class="token operator">:</span> <span class="token punctuation">{</span>
            age<span class="token operator">:</span> <span class="token number">20</span>
         <span class="token punctuation">}</span><span class="token punctuation">,</span>
         text<span class="token operator">:</span> <span class="token string">'&lt;h2&gt;v-text 显示的内容&lt;/h2&gt;'</span><span class="token punctuation">,</span>
         htmlText<span class="token operator">:</span> <span class="token string">'&lt;h2&gt;v-html 显示的内容&lt;/h2&gt;'</span><span class="token punctuation">,</span>
         link<span class="token operator">:</span> <span class="token string">'http://www.baidu.com'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      methods<span class="token operator">:</span> <span class="token punctuation">{</span>
         <span class="token function">clickHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
   window<span class="token punctuation">.</span>vm <span class="token operator">=</span> vm
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>可以看到，我们将会解析 <code>v-model</code>，<code></code>，<code>v-text</code>，<code>v-html</code>，<code>v-bind</code>，<code>v-on</code> 这些指令与模板。可以在浏览器中看到现在的展示：</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/36fec6aeee244b7eac1c3e93f8e9ef00~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>接着在 <code>Vue.js</code> 中：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Vue.js</span>
<span class="token keyword">import</span> Compile <span class="token keyword">from</span> <span class="token string">'./Compile.js'</span>
<span class="token keyword">import</span> Observer <span class="token keyword">from</span> <span class="token string">'./Observer.js'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Vue</span> <span class="token punctuation">{</span>
   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
      <span class="token comment">// 数据代理</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">proxyData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// 数据观测 / 数据劫持</span>
      <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$data<span class="token punctuation">)</span>
      <span class="token comment">// 模板编译</span>
      <span class="token keyword">new</span> <span class="token class-name">Compile</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这时我们就可以创建 <code>Compile.js</code> 文件并且实现 <code>Compile</code> 类了：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Compile.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Compile</span> <span class="token punctuation">{</span>
   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>el <span class="token operator">=</span> el
      <span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> vm
      <span class="token comment">// 将 DOM 添加到文档碎片中进行批量操作</span>
      <span class="token keyword">const</span> fragment <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">nodeToFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// 编译文档碎片</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span>
      <span class="token comment">// 将编译后的文档碎片添加回 DOM 中</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

   <span class="token function">nodeToFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> fragment <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createDocumentFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span>firstChild<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         fragment<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span>firstChild<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> fragment
   <span class="token punctuation">}</span>

   <span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">fragment</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里我们采用了文档碎片的方式将 <code>DOM</code> 储存起来，然后批量编译后追加回原来的容器中。这样做的好处就是避免大量的操作 <code>DOM</code> 引起性能力浪费，而是一次性的操作。</p> <p>之后的编译逻辑就在 <code>compile</code> 函数中展开了，我们需要遍历所有的节点，找出需要进行编译的节点，并且区分是编译模板还是指令：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Compile.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Compile</span> <span class="token punctuation">{</span>
   <span class="token comment">// ...</span>

   <span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">fragment</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 遍历孩子节点</span>
      Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>fragment<span class="token punctuation">.</span>childNodes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
         <span class="token comment">// 根据孩子节点的 nodeType 区分是元素节点还是文本节点</span>
         <span class="token comment">// 从而区分需要编译指令还是模板，再调用对应的方法分开编译</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compileElement</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compileText</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
         <span class="token comment">// 递归遍历所有的子节点</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>childNodes <span class="token operator">&amp;&amp;</span> child<span class="token punctuation">.</span>childNodes<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

   <span class="token function">compileElement</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

   <span class="token punctuation">}</span>

   <span class="token function">compileText</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>上面的代码中我们使用了 <code>Array.from</code> 来将 <code>childNodes</code> 这一类数组转化为数组来使用 <code>forEach</code> 方法，你也可以用其他方法。其实在 <code>chrome</code> 等浏览器中并不需要这么做，元素的子节点列表是有继承 <code>forEach</code> 这一方法的，我们可以直接使用，这里只是为了保证兼容性，以及照顾不懂的同学。</p></blockquote> <p>到这里之后我们就只需要分开分别实现 <code>compileElement</code> 方法和 <code>compileText</code> 方法来分别解析指令和模板就可以了。</p> <p>我们先来解析 <code></code> 语法：</p> <h3 id="模板语法解析"><a href="#模板语法解析" class="header-anchor">#</a> <code></code> 模板语法解析</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Compile.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Compile</span> <span class="token punctuation">{</span>
   <span class="token comment">// ...</span>
   
   <span class="token function">compileText</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> reg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\{\{(.+?)\}\}</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span>
      <span class="token keyword">const</span> content <span class="token operator">=</span> node<span class="token punctuation">.</span>textContent
      <span class="token keyword">if</span> <span class="token punctuation">(</span>reg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         Utils<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> content<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> Utils <span class="token operator">=</span> <span class="token punctuation">{</span>
   <span class="token function">getVal</span><span class="token punctuation">(</span><span class="token parameter">expr<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> expr<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> currentVal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> data<span class="token punctuation">[</span>currentVal<span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> vm<span class="token punctuation">.</span>$data<span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token function">text</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> expr<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Updater<span class="token punctuation">.</span>textUpdater
      <span class="token keyword">let</span> value <span class="token operator">=</span> expr<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\{\{(.+?)\}\}</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
         <span class="token keyword">const</span> key <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getVal</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">fn</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   Updater<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">textUpdater</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         node<span class="token punctuation">.</span>textContent <span class="token operator">=</span> value
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>分析一下上面的 <code>compileText</code> 做了哪些事：</p> <ul><li>编写一个匹配 <code></code> 的正则</li> <li>获取元素的文本内容，如果文本内容中有 <code></code> 就交给 <code>Utils.text</code> 来执行</li> <li><code>Utils.text</code> 方法会提取所有的 <code></code> 并将中间的内容</li> <li><code>textUpdater</code> 获取到中间表达式对应的数据值后将内容替换</li></ul> <p>经过这几步后我们可以在页面中看到：</p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/159e7cd75c9c49708c5a7495ac4e8416~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>可以发现所有的 <code></code> 可以被正确解析了。但是这里有一个问题，我们视图在控制台中修改 <code>vm.name</code> 属性值：<code>vm.name = 'juejin'</code>，这并不会引起视图的更新。</p> <p>这时因为我们还没有为这里的所有 <code></code> 添加监听器 <code>watcher</code>，当我们添加添加监听器后，数据变化后监听器会自动执行 <code>update</code> 方法，之后调用回调函数，我们可以在回调函数中更新视图：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Compile.js</span>
<span class="token keyword">import</span> Watcher <span class="token keyword">from</span> <span class="token string">&quot;./Watcher.js&quot;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Compile</span> <span class="token punctuation">{</span>
   <span class="token comment">// ...</span>
   
   <span class="token function">compileText</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> reg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\{\{(.+?)\}\}</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span>
      <span class="token keyword">const</span> content <span class="token operator">=</span> node<span class="token punctuation">.</span>textContent
      <span class="token keyword">if</span> <span class="token punctuation">(</span>reg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         Utils<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> content<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> Utils <span class="token operator">=</span> <span class="token punctuation">{</span>
   <span class="token function">getContentValue</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> expr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> value <span class="token operator">=</span> expr<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\{\{(.+?)\}\}</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getVal</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> value
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token function">text</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> expr<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Updater<span class="token punctuation">.</span>textUpdater
      <span class="token keyword">let</span> value <span class="token operator">=</span> expr<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\{\{(.+?)\}\}</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
         <span class="token keyword">const</span> key <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">fn</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getContentValue</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> expr<span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">}</span><span class="token punctuation">)</span>
         <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getVal</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">fn</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token function">getVal</span><span class="token punctuation">(</span><span class="token parameter">expr<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> expr<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> currentVal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> data<span class="token punctuation">[</span>currentVal<span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> vm<span class="token punctuation">.</span>$data<span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   Updater<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">textUpdater</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         node<span class="token punctuation">.</span>textContent <span class="token operator">=</span> value
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>上面的代码我们在 <code>Utils.text</code> 方法中新增了一个监听器，每当 <code></code> 中的数据发生改变，都会重新渲染视图。</p> <p>这时，我们再来验证一下：</p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c0e9c01ba06f4e2bb1523e63803bfaed~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>可以看到对于 <code></code> 的数据驱动视图的变化已经生效了，这完全得益于我们之前实现好的响应式系统。</p> <p>接下来，我们将要实现一个个指令的编译。对于复杂情形，比如修饰符 <code>.stop</code> 等这里就不再实现，基础结构搭建好后，这些都是可以进行扩展的。</p> <h3 id="v-xxx-指令编译"><a href="#v-xxx-指令编译" class="header-anchor">#</a> <code>v-xxx</code> 指令编译</h3> <p>实现了模板的编译后我们其实就知道了编译的大致流程，对于模板的编译就是获取到表达式后，用数据替换表达式。</p> <p>同样的，对于指令的编译，也是在这一基础上添加了一个解析是哪一条指令的操作。我们先来区分每一条指令对应的类型，以及获取它依赖的值：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Compile.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Compile</span> <span class="token punctuation">{</span>
   <span class="token comment">// ...</span>
   <span class="token comment">// 编译元素标签</span>
   <span class="token function">compileElement</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 获取所有的属性并且遍历</span>
      <span class="token keyword">const</span> attrs <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>attributes<span class="token punctuation">)</span>
      attrs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">attr</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
         <span class="token comment">// 如果含有指令属性就进行解析</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>attr<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'v-'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> name <span class="token operator">=</span> attr<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'v-'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            <span class="token keyword">const</span> <span class="token punctuation">[</span>directive<span class="token punctuation">,</span> methodName<span class="token punctuation">]</span> <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>
            <span class="token keyword">const</span> value <span class="token operator">=</span> attr<span class="token punctuation">.</span>value
            <span class="token comment">// 每一种指令对应一种解析方法</span>
            Utils<span class="token punctuation">[</span>directive<span class="token punctuation">]</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">,</span> methodName<span class="token punctuation">)</span>
            <span class="token comment">// 最后标签上面丑陋的 v-xxx 属性</span>
            <span class="token keyword">const</span> removedDirective <span class="token operator">=</span> methodName <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">v-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>directive<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>methodName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token string">'v-'</span> <span class="token operator">+</span> directive<span class="token punctuation">)</span>
            node<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>removedDirective<span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> Utils <span class="token operator">=</span> <span class="token punctuation">{</span>
   <span class="token function">model</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> expr<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token function">html</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> expr<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token function">bind</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> expr<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token function">on</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> expr<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token function">text</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> expr<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Updater<span class="token punctuation">.</span>textUpdater
      <span class="token keyword">let</span> value <span class="token operator">=</span> expr<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\{\{(.+?)\}\}</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
         <span class="token keyword">const</span> key <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">fn</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getContentValue</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> expr<span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">}</span><span class="token punctuation">)</span>
         <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getVal</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">fn</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过上述代码，我们已经区分开了这些指令，并且对于不同的指令我们都有单独的方法来处理。这里可以发现对于 <code>v-text</code> 指令的处理和 <code></code> 的处理使用了同一个方法，所以我们要修改一下 <code>text</code> 方法，让他可以适配 <code>v-text</code> 指令：</p> <h4 id="v-text"><a href="#v-text" class="header-anchor">#</a> <code>v-text</code></h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Compile.js</span>
<span class="token function">text</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> expr<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Updater<span class="token punctuation">.</span>textUpdater
   <span class="token keyword">let</span> value
   <span class="token comment">// 如果是解析 {{ }} 按之前的逻辑</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>expr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'{{'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      value <span class="token operator">=</span> expr<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\{\{(.+?)\}\}</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
         <span class="token keyword">const</span> key <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">fn</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getContentValue</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> expr<span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">}</span><span class="token punctuation">)</span>
         <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getVal</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 否则是解析 v-text ，此时直接取值并对值进行侦测</span>
      value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getVal</span><span class="token punctuation">(</span>expr<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
      <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> expr<span class="token punctuation">,</span> <span class="token parameter">newVal</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
         <span class="token function">fn</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token function">fn</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以在页面中看到：</p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e19c30e1ac234592953a1474e641b47d~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>这只是简单的文本展示，并没有识别标签，可以识别标签的指令应该是 <code>v-html</code>，我们来实现一下它：</p> <h4 id="v-html"><a href="#v-html" class="header-anchor">#</a> <code>v-html</code></h4> <p>分析 <code>v-html</code> 的作用其实就是将表达式对应的值替换为元素节点的 <code>innerHTML</code> 值：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Compile.js</span>
<span class="token keyword">const</span> Utils <span class="token operator">=</span> <span class="token punctuation">{</span>
   <span class="token function">html</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> expr<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Updater<span class="token punctuation">.</span>htmlUpdater
      <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getVal</span><span class="token punctuation">(</span>expr<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
      <span class="token comment">// 添加监听器，侦测数据变化</span>
      <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> expr<span class="token punctuation">,</span> <span class="token parameter">newValue</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
         <span class="token function">fn</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">fn</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   Updater<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">htmlUpdater</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         node<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> value
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这时可以在页面中看到 <code>&lt;h2&gt;</code> 标签已经被解析出来了：</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9ca2246855e04a7481bdb4747dfbd3cd~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>此时，当我们修改值得时候页面得视图会自动做出变化，可以测试一下：</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/832147c7a24c4297bb0e70daaebc0e81~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>可以看到我们的 <code>v-text</code> 和 <code>v-html</code> 指令都没有问题。</p> <p>接着我们先实现以下较为简单的 <code>v-bind</code> 指令从而实现页面中的 <code>&lt;a&gt;</code> 标签的跳转功能：</p> <h4 id="v-bind"><a href="#v-bind" class="header-anchor">#</a> <code>v-bind</code></h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Compile.js</span>
<span class="token keyword">const</span> Utils <span class="token operator">=</span> <span class="token punctuation">{</span>
   <span class="token function">bind</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> expr<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> attr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Updater<span class="token punctuation">.</span>bindUpdater
      <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getVal</span><span class="token punctuation">(</span>expr<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
      <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> expr<span class="token punctuation">,</span> <span class="token parameter">newVal</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
         <span class="token function">fn</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> attr<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">fn</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> attr<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   Updater<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">bindUpdater</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> attr<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         node<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>attr<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以到页面中发现我们的 <code>&lt;a&gt;&lt;/a&gt;</code> 标签已经拥有了跳转功能，并且标签上的属性也显示正常：</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fac29fabb9b5444b9cb632711fba4026~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <h4 id="v-model"><a href="#v-model" class="header-anchor">#</a> <code>v-model</code></h4> <p>接下来应该就是 <code>Vue</code> 中的重头戏了，表单数据的双向绑定 <code>v-model</code> 的实现。我们先来对它进行一些分析：</p> <ul><li>根据数据显示 <code>input</code> 中的值</li> <li>当用户在输入框中输入值时改变数据的值</li></ul> <p>我们先来实现第一步，根据数据显示 <code>input</code> 中的值：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Compile.js</span>
<span class="token keyword">const</span> Utils <span class="token operator">=</span> <span class="token punctuation">{</span>
   <span class="token function">model</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> expr<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Updater<span class="token punctuation">.</span>modelUpdater
      <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getVal</span><span class="token punctuation">(</span>expr<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
      <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> expr<span class="token punctuation">,</span> <span class="token parameter">newVal</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
         <span class="token function">fn</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">fn</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   Updater<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">modelUpdater</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         node<span class="token punctuation">.</span>value <span class="token operator">=</span> value
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们来测试一下显示与其响应式：</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/508347698cc64d9fb0dc17d30920d58c~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>可以看到一切都正如所料，数据的变化可以驱动试图的变化。</p> <p>接下来我们来实现当用户进行输入的时候，数据同步的发生变化，所以我们要监听用户的表单的 <code>input</code> 事件：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Compile.js</span>
<span class="token keyword">const</span> Utils <span class="token operator">=</span> <span class="token punctuation">{</span>
   <span class="token function">model</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> expr<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Updater<span class="token punctuation">.</span>modelUpdater
      <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getVal</span><span class="token punctuation">(</span>expr<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
      <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> expr<span class="token punctuation">,</span> <span class="token parameter">newVal</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
         <span class="token function">fn</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">fn</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
      <span class="token comment">// 监听用户的输入事件，同时给 data 中的数据设置值</span>
      node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setVal</span><span class="token punctuation">(</span>expr<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token function">setVal</span><span class="token punctuation">(</span><span class="token parameter">expr<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      expr<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> currentVal<span class="token punctuation">,</span> index<span class="token punctuation">,</span> arr</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">===</span> arr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> data<span class="token punctuation">[</span>currentVal<span class="token punctuation">]</span> <span class="token operator">=</span> value
         <span class="token punctuation">}</span>
         <span class="token keyword">return</span> data<span class="token punctuation">[</span>currentVal<span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> vm<span class="token punctuation">.</span>$data<span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   Updater<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">modelUpdater</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         node<span class="token punctuation">.</span>value <span class="token operator">=</span> value
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>上面的代码中设置值的操作使用到了高阶函数 <code>reduce</code> 的 <code>callback</code> 中的四个参数，如果不了解，你可以前往 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array/Reduce" target="_blank" rel="noopener noreferrer">MDN 文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>查看。</p></blockquote> <p>这样我们就完成了第二步监听用户输入，视图影响数据的操作，我们来验证一下：</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/54c34d3043f24f5687137f1234e6cfc6~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>可以看到视图与数据的双向绑定就这样实现好了。</p> <h4 id="v-on"><a href="#v-on" class="header-anchor">#</a> <code>v-on</code></h4> <p>最后我们来实现以下 <code>v-on</code> 指令吧！</p> <p><code>v-on</code> 指令做了一件事：</p> <ul><li>给 <code>DOM</code> 元素绑定事件</li></ul> <p>但是绑定的事件我们先要代理到实例对象 <code>vm</code> 上才能获取到，我们先来进行数据代理的操作：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Vue.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Vue</span> <span class="token punctuation">{</span>
   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   	  <span class="token comment">// ...</span>
      <span class="token comment">// 事件的代理</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">proxyMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// ...</span>
   <span class="token punctuation">}</span>

   <span class="token function">proxyMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> methods <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>methods <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>methods <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> methodName <span class="token keyword">in</span> methods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> methodName<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            configurable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">return</span> methods<span class="token punctuation">[</span>methodName<span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function">set</span><span class="token punctuation">(</span>newMethod<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               methods<span class="token punctuation">[</span>methodName<span class="token punctuation">]</span> <span class="token operator">=</span> newMethod
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此时我们可以通过 <code>vm.clickHandler</code> 获取到用户定义的方法了，就可以实现 <code>v-on</code> 指令：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Compile.js</span>
<span class="token keyword">const</span> Utils <span class="token operator">=</span> <span class="token punctuation">{</span>
   <span class="token function">on</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> expr<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> methodName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Updater<span class="token punctuation">.</span>onUpdater
      <span class="token keyword">const</span> method <span class="token operator">=</span> vm<span class="token punctuation">[</span>expr<span class="token punctuation">]</span>
      <span class="token function">fn</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> methodName<span class="token punctuation">,</span> method<span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   Updater<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">onUpdater</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> methodType<span class="token punctuation">,</span> method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>methodType<span class="token punctuation">,</span> method<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个时候我们的按钮的点击事件就已经添加好了，我们可以验证一下：</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bb1802313fd8436e8d06c8222b210df6~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>我们从 0 开始实现了一版 <code>Vue2.x</code> 中的响应式系统，深入其原理。逐一实现了<strong>数据代理</strong>、<strong>响应式系统的搭建</strong>、<strong>模板编译</strong>等模块。</p> <p>我们分析了响应式系统中的优缺点，对不能监测到的数据变化进行了分析，主要有：</p> <ul><li>对象属性的添加</li> <li>对象属性的删除</li></ul> <p>其实对于数组元素来说，也有两个操作不能进行检测：</p> <ul><li>利用索引直接设置一个数组项</li> <li>修改数组的长度 <code>length</code></li></ul> <p>对于数组的响应式实现近期也会抽空加入本文，尽请期待。</p> <p>最后再来附上一开始的 <code>MVVM</code> 模式的图片，相信此时你会对它由更加深入的理解：</p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/849fda0fc0724ab3847a07f138b19531~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>还有 <code>Vue2.x</code> 中响应式系统的基础架构图，此时通过代码的书写相信你肯定可以理清图中的所有脉络：</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f73eaf8d024149d885254ca98c9f8481~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/fxburning/assets/js/app.9058f1ce.js" defer></script><script src="/fxburning/assets/js/2.ee1c7fd8.js" defer></script><script src="/fxburning/assets/js/12.e04f6e73.js" defer></script>
  </body>
</html>
